# データベース設計書

このドキュメントは、`meetupr-backend`アプリケーションのデータベーススキーマを定義します。

## テーブル一覧

-   [users](#1-users-ユーザー情報)
-   [profiles](#2-profiles-プロフィール詳細)
-   [interests](#3-interests-興味趣味-マスタ)
-   [user_interests](#4-user_interests-ユーザーと興味の関連付け)
-   [chats](#5-chats-チャットルーム)
-   [messages](#6-messages-メッセージ履歴)
-   [anon_interest_buttons](#7-anon_interest_buttons-匿名会いたいボタン)
-   [events](#8-events-学校主催イベントミッション)

---

### 1. users (ユーザー情報)

Auth0のIDと連携するユーザーの基本情報を格納します。

**スキーマ:**

```sql
CREATE TABLE users (
    id text PRIMARY KEY, -- Auth0のユーザーID（例: auth0|xxxxxxxxxx）
    email text UNIQUE NOT NULL,
    username text UNIQUE NOT NULL,
    is_oic_verified boolean NOT NULL DEFAULT false,
    created_at timestamptz NOT NULL DEFAULT now()
);
```

**カラム:**

| カラム名         | データ型      | 説明                                       |
| ---------------- | ------------- | ------------------------------------------ |
| id               | text          | 主キー。Auth0のユーザーID。                |
| email            | text          | ユーザーのメールアドレス。一意である必要があります。 |
| username         | text          | ユーザー名。一意である必要があります。     |
| is_oic_verified | boolean       | OICの学生認証が完了しているかどうかのフラグ。 |
| created_at      | timestamptz   | レコード作成日時。                         |

---

### 2. profiles (プロフィール詳細)

ユーザーのより詳細なプロフィール情報を格納します。

**スキーマ:**

```sql
CREATE TABLE profiles (
    user_id text PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    major text,
    gender text,
    native_language text NOT NULL,
    spoken_languages text[],
    learning_languages text[],
    residence text,
    comment text,
    last_updated timestamptz NOT NULL DEFAULT now()
);
```

**カラム:**

| カラム名             | データ型      | 説明                                       |
| -------------------- | ------------- | ------------------------------------------ |
| user_id             | text          | 主キーであり、`users`テーブルへの外部キー。 |
| major                | text          | 専攻。                                     |
| gender               | text          | 性別。                                     |
| native_language     | text          | 母国語。                                   |
| spoken_languages    | text[]        | 話せる言語の配列。                         |
| learning_languages  | text[]        | 学習中の言語の配列。                       |
| residence            | text          | 居住地。                                   |
| comment              | text          | 自己紹介などのコメント。                   |
| last_updated        | timestamptz   | 最終更新日時。                             |

---

### 3. interests (興味・趣味 マスタ)

ユーザーが選択できる興味・趣味のマスターデータです。

**スキーマ:**

```sql
CREATE TABLE interests (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name text UNIQUE NOT NULL,
    category text
);
```

**カラム:**

| カラム名 | データ型 | 説明                               |
| -------- | -------- | ---------------------------------- |
| id       | bigint   | 主キー。自動採番されます。         |
| name     | text     | 興味・趣味の名称。一意である必要があります。 |
| category | text     | カテゴリ（例: スポーツ、音楽など）。 |

---

### 4. user_interests (ユーザーと興味の関連付け)

ユーザーと興味・趣味を関連付ける中間テーブルです。

**スキーマ:**

```sql
CREATE TABLE user_interests (
    user_id text REFERENCES users(id) ON DELETE CASCADE,
    interest_id bigint REFERENCES interests(id) ON DELETE CASCADE,
    preference_level integer,
    PRIMARY KEY (user_id, interest_id)
);
```

**カラム:**

| カラム名         | データ型 | 説明                                                         |
| ---------------- | -------- | ------------------------------------------------------------ |
| user_id         | text     | `users`テーブルへの外部キー。                                |
| interest_id     | bigint   | `interests`テーブルへの外部キー。                            |
| preference_level | integer  | 興味の度合い（例: 1〜5）。                                   |

---

### 5. chats (チャットルーム)

ユーザー間のチャットルーム情報を格納します。

**スキーマ:**

```sql
CREATE TABLE chats (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user1_id text REFERENCES users(id) ON DELETE CASCADE,
    user2_id text REFERENCES users(id) ON DELETE CASCADE,
    ai_suggested_theme text,
    created_at timestamptz NOT NULL DEFAULT now()
);

CREATE UNIQUE INDEX idx_unique_chat_pair
ON chats (LEAST(user1_id, user2_id), GREATEST(user1_id, user2_id));
```

**カラム:**

| カラム名             | データ型      | 説明                                                         |
| -------------------- | ------------- | ------------------------------------------------------------ |
| id                   | bigint        | 主キー。自動採番されます。                                   |
| user1_id            | text          | `users`テーブルへの外部キー。チャット参加者1。               |
| user2_id            | text          | `users`テーブルへの外部キー。チャット参加者2。               |
| ai_suggested_theme | text          | AIによって提案された会話のテーマ。                           |
| created_at          | timestamptz   | レコード作成日時。                                           |

**インデックス:**

-   `idx_unique_chat_pair`: `user1_id`と`user2_id`のペアが一意であることを保証します。

---

### 6. messages (メッセージ履歴)

各チャットルームでのメッセージ履歴を格納します。

**スキーマ:**

```sql
CREATE TABLE messages (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    chat_id bigint REFERENCES chats(id) ON DELETE CASCADE,
    sender_id text REFERENCES users(id) ON DELETE CASCADE,
    content text NOT NULL,
    translated_content text,
    message_type text NOT NULL,
    sent_at timestamptz NOT NULL DEFAULT now()
);
```

**カラム:**

| カラム名             | データ型      | 説明                                                         |
| -------------------- | ------------- | ------------------------------------------------------------ |
| id                   | bigint        | 主キー。自動採番されます。                                   |
| chat_id             | bigint        | `chats`テーブルへの外部キー。                                |
| sender_id           | text          | `users`テーブルへの外部キー。メッセージの送信者。            |
| content              | text          | メッセージの本文。                                           |
| translated_content  | text          | 翻訳されたメッセージの本文。                                 |
| message_type        | text          | メッセージの種類（例: text, image, stamp）。                 |
| sent_at             | timestamptz   | 送信日時。                                                   |

---

### 7. anon_interest_buttons (匿名会いたいボタン)

匿名で「会いたい」という意思表示を送るためのテーブルです。

**スキーマ:**

```sql
CREATE TABLE anon_interest_buttons (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    sender_id text REFERENCES users(id) ON DELETE CASCADE,
    recipient_id text REFERENCES users(id) ON DELETE CASCADE,
    created_at timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT unique_button_press UNIQUE (sender_id, recipient_id)
);
```

**カラム:**

| カラム名     | データ型      | 説明                                                         |
| ------------ | ------------- | ------------------------------------------------------------ |
| id           | bigint        | 主キー。自動採番されます。                                   |
| sender_id   | text          | `users`テーブルへの外部キー。送信者。                        |
| recipient_id | text          | `users`テーブルへの外部キー。受信者。                        |
| created_at   | timestamptz   | レコード作成日時。                                           |

**制約:**

-   `unique_button_press`: 送信者と受信者のペアが一意であることを保証します。

---

### 8. events (学校主催イベント/ミッション)

学校が主催するイベントやミッションの情報を格納します。

**スキーマ:**

```sql
CREATE TABLE events (
    id bigint PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    title text NOT NULL,
    description text,
    event_type text NOT NULL,
    start_time timestamptz NOT NULL,
    end_time timestamptz,
    chat_link_enabled boolean NOT NULL DEFAULT false
);
```

**カラム:**

| カラム名            | データ型      | 説明                                                         |
| ------------------- | ------------- | ------------------------------------------------------------ |
| id                  | bigint        | 主キー。自動採番されます。                                   |
| title               | text          | イベント/ミッションのタイトル。                              |
| description         | text          | 詳細な説明。                                                 |
| event_type         | text          | イベントの種類（例: mission, school_event）。                |
| start_time         | timestamptz   | 開始日時。                                                   |
| end_time           | timestamptz   | 終了日時。                                                   |
| chat_link_enabled | boolean       | イベントに関連するチャット機能が有効かどうかのフラグ。       |
